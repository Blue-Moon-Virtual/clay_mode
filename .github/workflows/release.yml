name: Create Blender Addon Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Check out the repository.
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up version variable (extracted from the tag).
      - name: Set up version variable
        id: get_version
        run: |
          # This extracts the tag name (e.g. "v1.3" or "1.3") from GITHUB_REF.
          VERSION="${GITHUB_REF##*/}"
          # If you want to strip a leading "v", uncomment the next line:
          # VERSION="${VERSION#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Detected version: ${VERSION}"

      # (Optional) Debug: List root directory to verify folder names.
      - name: List repository root
        run: ls -la

      # Step 3: Prepare the add-on folder.
      # Blender requires that the internal folder name (when installing from a zip)
      # exactly matches the module name declared in __init__.py.
      # This step copies your add-on folder into a temporary "release" folder.
      - name: Prepare add-on for release
        run: |
          mkdir -p release
          # Check if the folder exists as "claymode" or "clay_mode" and copy it as "claymode".
          if [ -d claymode ]; then
            echo "Found folder 'claymode'"
            cp -r claymode release/claymode
          elif [ -d clay_mode ]; then
            echo "Found folder 'clay_mode' (will be renamed to 'claymode' in the zip)"
            cp -r clay_mode release/claymode
          else
            echo "Error: Could not find your add-on folder. Ensure that a folder named 'claymode' or 'clay_mode' exists at the repository root."
            exit 1
          fi

      # Step 4: Create the release zip.
      # The zip file is named with the version (e.g. clay_mode-1.3.zip)
      # and its internal folder is named "claymode", which Blender expects.
      - name: Create release zip
        run: |
          cd release
          zip -r ../clay_mode-${VERSION}.zip claymode

      # Step 5: Upload the zip file to the GitHub release.
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./clay_mode-${{ env.VERSION }}.zip
          asset_name: clay_mode-${{ env.VERSION }}.zip
          asset_content_type: application/zip
